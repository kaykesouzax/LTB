<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Revemar ¬∑ Preenchimento Autom√°tico</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --red: #CC0000; --red-dim: #990000;
      --dark: #0d0d0d; --surface: #141414;
      --border: #242424; --muted: #555;
      --text: #e8e8e8; --green: #2d9e5f;
    }
    html { scroll-behavior: smooth; }
    body {
      background: var(--dark); color: var(--text);
      font-family: 'DM Sans', sans-serif; font-weight: 300;
      min-height: 100vh; overflow-x: hidden;
    }
    body::before {
      content: ''; position: fixed; inset: 0; z-index: 0;
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 48px 48px; opacity: 0.4; pointer-events: none;
    }
    header {
      position: sticky; top: 0; z-index: 100;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 40px; height: 60px;
      background: rgba(13,13,13,0.92); backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }
    .logo { display: flex; align-items: center; gap: 14px; }
    .logo-name { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 900; color: var(--red); letter-spacing: 3px; }
    .logo-sep { width: 1px; height: 22px; background: var(--border); }
    .logo-city { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 900; font-style: italic; color: var(--red); letter-spacing: 2px; }
    .header-right { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; text-align: right; line-height: 1.4; }
    .hero { position: relative; z-index: 1; padding: 80px 40px 60px; max-width: 760px; margin: 0 auto; }
    .hero-eyebrow { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--red); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 16px; }
    .hero-title { font-family: 'Playfair Display', serif; font-size: clamp(36px, 5vw, 56px); font-weight: 900; line-height: 1.1; margin-bottom: 20px; }
    .hero-title span { color: var(--red); }
    .hero-sub { font-size: 16px; color: #888; line-height: 1.7; max-width: 520px; }
    .main-card { position: relative; z-index: 1; max-width: 760px; margin: 0 auto 80px; padding: 0 40px; }
    .config-box { background: #0f0f0f; border: 1px solid var(--border); padding: 20px; margin-bottom: 32px; }
    .config-box-title { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--red); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 12px; }
    .steps { display: flex; margin-bottom: 40px; border: 1px solid var(--border); }
    .step { flex: 1; padding: 18px 20px; border-right: 1px solid var(--border); cursor: pointer; transition: background 0.2s; position: relative; }
    .step:last-child { border-right: none; }
    .step:hover { background: #1a1a1a; }
    .step.active { background: #1a1a1a; }
    .step.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: var(--red); }
    .step.done .step-num { background: var(--green); color: white; }
    .step-num { width: 24px; height: 24px; background: var(--border); color: var(--muted); display: flex; align-items: center; justify-content: center; font-family: 'DM Mono', monospace; font-size: 11px; margin-bottom: 8px; }
    .step-label { font-size: 12px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; font-family: 'DM Mono', monospace; }
    .step.active .step-label { color: var(--text); }
    .panel { display: none; }
    .panel.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .field-label { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; display: block; }
    .field-label.required::after { content: ' *'; color: var(--red); }
    textarea, input[type="text"] {
      width: 100%; background: var(--surface); border: 1px solid var(--border);
      color: var(--text); font-family: 'DM Mono', monospace;
      font-size: 13px; line-height: 1.7; padding: 16px 18px;
      resize: vertical; outline: none; transition: border-color 0.2s;
    }
    textarea:focus, input:focus { border-color: var(--red); }
    textarea { min-height: 300px; }
    input.error { border-color: #cc3333 !important; }
    .error-msg { font-family: 'DM Mono', monospace; font-size: 11px; color: #f88; margin-top: 6px; display: none; }
    .error-msg.show { display: block; }
    .fields-row { display: flex; gap: 16px; margin-bottom: 16px; }
    .fields-row .field-group { flex: 1; }
    .upload-zone { border: 1px dashed var(--border); padding: 48px 24px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; background: var(--surface); }
    .upload-zone:hover, .upload-zone.drag { border-color: var(--red); background: #1a1010; }
    .upload-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .upload-icon { font-size: 32px; margin-bottom: 12px; }
    .upload-title { font-size: 15px; color: var(--text); margin-bottom: 6px; }
    .upload-hint { font-size: 12px; color: var(--muted); font-family: 'DM Mono', monospace; }
    .upload-success { display: none; align-items: center; gap: 10px; background: #0d1f14; border: 1px solid #2d9e5f; padding: 14px 18px; margin-top: 12px; }
    .upload-success.show { display: flex; }
    .upload-success-icon { color: var(--green); font-size: 18px; }
    .upload-success-name { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--green); }
    .btn { padding: 14px 28px; font-family: 'DM Mono', monospace; font-size: 12px; letter-spacing: 2px; text-transform: uppercase; border: none; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: var(--red); color: white; }
    .btn-primary:hover { background: var(--red-dim); }
    .btn-primary:disabled { background: #333; color: var(--muted); cursor: not-allowed; }
    .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); }
    .btn-ghost:hover { color: var(--text); border-color: #444; }
    .btn-row { display: flex; gap: 12px; margin-top: 24px; align-items: center; }
    .status-bar { display: none; align-items: center; gap: 12px; padding: 14px 18px; margin-top: 16px; font-family: 'DM Mono', monospace; font-size: 12px; }
    .status-bar.show { display: flex; }
    .status-bar.loading { background: #1a1610; border: 1px solid #554; color: #aa9; }
    .status-bar.error   { background: #1a0d0d; border: 1px solid #c33; color: #f88; }
    .status-bar.success { background: #0d1a12; border: 1px solid var(--green); color: #6f6; }
    .spinner { width: 16px; height: 16px; border: 2px solid #554; border-top-color: #aa9; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .manual-box { background: #0f0f0f; border: 1px solid var(--red); padding: 20px; margin-bottom: 24px; }
    .manual-box-title { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--red); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 16px; }
    /* Vendedor preview */
    .vendedor-preview { display: none; background: #0d1a12; border: 1px solid var(--green); padding: 12px 16px; margin-top: 10px; }
    .vendedor-preview.show { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
    .vendedor-info { font-family: 'DM Mono', monospace; font-size: 11px; }
    .vendedor-info span { color: var(--muted); margin-right: 6px; }
    .vendedor-info strong { color: #6f6; }
    .summary-box { background: var(--surface); border: 1px solid var(--border); padding: 20px; margin-bottom: 24px; }
    .summary-row { display: flex; gap: 12px; margin-bottom: 10px; }
    .summary-row:last-child { margin-bottom: 0; }
    .summary-key { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); width: 130px; flex-shrink: 0; }
    .summary-val { font-size: 13px; }
    .summary-val.green { color: var(--green); font-family: 'DM Mono', monospace; font-size: 12px; }
    footer { position: relative; z-index: 1; border-top: 1px solid var(--border); padding: 20px 40px; text-align: center; font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 2px; }
    @media (max-width: 600px) {
      header, .hero, .main-card { padding-left: 20px; padding-right: 20px; }
      .steps { flex-direction: column; }
      .step { border-right: none; border-bottom: 1px solid var(--border); }
      .step:last-child { border-bottom: none; }
      .fields-row { flex-direction: column; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <span class="logo-name">REVEMAR</span>
    <div class="logo-sep"></div>
    <span class="logo-city">HUMAIT√Å</span>
  </div>
  <span class="header-right">Preenchimento<br>Autom√°tico</span>
</header>

<section class="hero">
  <div class="hero-eyebrow">Termo para Cotas</div>
  <h1 class="hero-title">Cole os dados.<br><span>O documento ser√° preenchido.</span></h1>
  <p class="hero-sub">Cole as informa√ß√µes do cliente conforme o IHS, fa√ßa o upload dos termos atualizados das cotas e baixe o PDF pronto para subir o processo.</p>
</section>

<main class="main-card">

  <div class="steps">
    <div class="step active" id="step-tab-1" onclick="goStep(1)">
      <div class="step-num" id="step-num-1">1</div>
      <div class="step-label">Dados do cliente</div>
    </div>
    <div class="step" id="step-tab-2" onclick="goStep(2)">
      <div class="step-num" id="step-num-2">2</div>
      <div class="step-label">Upload do template</div>
    </div>
    <div class="step" id="step-tab-3" onclick="goStep(3)">
      <div class="step-num" id="step-num-3">3</div>
      <div class="step-label">Gerar PDF</div>
    </div>
  </div>

  <!-- Painel 1 -->
  <div class="panel active" id="panel-1">
    <label class="field-label">Dados do cliente (cole o texto do seu sistema)</label>
    <textarea id="clientData" placeholder="Nome:
FULANO DA SILVA
CPF:
000.000.000-00
..."></textarea>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="validateStep1()">Pr√≥ximo ‚Üí</button>
      <span id="step1-hint" style="font-family:'DM Mono',monospace;font-size:11px;color:#c33;"></span>
    </div>
  </div>

  <!-- Painel 2 -->
  <div class="panel" id="panel-2">
    <label class="field-label">Template PDF da empresa</label>
    <div class="upload-zone" id="uploadZone">
      <input type="file" id="pdfFile" accept=".pdf" onchange="handleFile(this)"/>
      <div class="upload-icon">üìÑ</div>
      <div class="upload-title">Clique ou arraste o PDF aqui</div>
      <div class="upload-hint">Apenas arquivos .pdf</div>
    </div>
    <div class="upload-success" id="uploadSuccess">
      <span class="upload-success-icon">‚úì</span>
      <span class="upload-success-name" id="uploadFileName"></span>
    </div>
    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goStep(1)">‚Üê Voltar</button>
      <button class="btn btn-primary" id="btn-step2" onclick="validateStep2()" disabled>Pr√≥ximo ‚Üí</button>
    </div>
  </div>

  <!-- Painel 3 -->
  <div class="panel" id="panel-3">
    <div class="manual-box">
      <div class="manual-box-title">‚ö† Campos obrigat√≥rios ‚Äî preencha antes de gerar</div>

      <!-- Matr√≠cula em linha pr√≥pria -->
      <div style="margin-bottom:16px;">
        <label class="field-label required">Matr√≠cula do Vendedor</label>
        <input type="text" id="matricula" placeholder="Ex: 29070001" oninput="onMatriculaInput()"/>
        <div class="error-msg" id="err-matricula">Matr√≠cula n√£o encontrada ou campo vazio</div>
        <div class="vendedor-preview" id="vendedorPreview">
          <div class="vendedor-info"><span>VENDEDOR</span><strong id="preview-nome">‚Äî</strong></div>
          <div class="vendedor-info"><span>PDV</span><strong id="preview-pdv">‚Äî</strong></div>
          <div class="vendedor-info"><span>FRETE</span><strong id="preview-frete">‚Äî</strong></div>
        </div>
      </div>

      <!-- Proposta e Recibo lado a lado -->
      <div class="fields-row">
        <div class="field-group">
          <label class="field-label required">N¬∫ da Proposta</label>
          <input type="text" id="nproposta" placeholder="Ex: 89485611-1" oninput="clearError('nproposta')"/>
          <div class="error-msg" id="err-nproposta">Campo obrigat√≥rio</div>
        </div>
        <div class="field-group">
          <label class="field-label required">N¬∫ do Recibo</label>
          <input type="text" id="nrecibo" placeholder="Ex: 1218687705210902" oninput="clearError('nrecibo')"/>
          <div class="error-msg" id="err-nrecibo">Campo obrigat√≥rio</div>
        </div>
      </div>
    </div>

    <!-- Resumo -->
    <div class="summary-box">
      <div class="summary-row"><span class="summary-key">CLIENTE</span><span class="summary-val" id="summary-nome">‚Äî</span></div>
      <div class="summary-row"><span class="summary-key">CPF</span><span class="summary-val" id="summary-cpf" style="font-family:'DM Mono',monospace;font-size:12px;">‚Äî</span></div>
      <div class="summary-row"><span class="summary-key">MODELO</span><span class="summary-val" id="summary-modelo">‚Äî</span></div>
      <div class="summary-row"><span class="summary-key">TEMPLATE</span><span class="summary-val green" id="summary-pdf">‚Äî</span></div>
    </div>

    <div class="status-bar" id="statusBar">
      <div class="spinner" id="spinner"></div>
      <span id="statusMsg">Processando...</span>
    </div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goStep(2)">‚Üê Voltar</button>
      <button class="btn btn-primary" id="btn-gerar" onclick="gerarPDF()">‚¨á Gerar e Baixar PDF</button>
    </div>
  </div>

</main>

<footer>REVEMAR HUMAIT√Å ¬∑ SISTEMA DE PREENCHIMENTO AUTOM√ÅTICO ¬∑ FEITO POR KAYKE</footer>

<script>
  let pdfFileSelected = null;
  let vendedorValido  = false;

  function goStep(n) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(`panel-${n}`).classList.add('active');
    document.getElementById(`step-tab-${n}`).classList.add('active');
    if (n === 3) buildSummary();
  }

  function markDone(n) {
    document.getElementById(`step-num-${n}`).textContent = '‚úì';
    document.getElementById(`step-tab-${n}`).classList.add('done');
  }

  function validateStep1() {
    const raw = document.getElementById('clientData').value.trim();
    if (!raw) { document.getElementById('step1-hint').textContent = 'Cole os dados do cliente primeiro.'; return; }
    document.getElementById('step1-hint').textContent = '';
    markDone(1); goStep(2);
  }

  function handleFile(input) {
    if (input.files && input.files[0]) {
      pdfFileSelected = input.files[0];
      document.getElementById('uploadFileName').textContent = pdfFileSelected.name;
      document.getElementById('uploadSuccess').classList.add('show');
      document.getElementById('btn-step2').disabled = false;
    }
  }

  function validateStep2() {
    if (!pdfFileSelected) return;
    markDone(2); goStep(3);
  }

  const zone = document.getElementById('uploadZone');
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag'));
  zone.addEventListener('drop', e => {
    e.preventDefault(); zone.classList.remove('drag');
    const file = e.dataTransfer.files[0];
    if (file && file.type === 'application/pdf') {
      pdfFileSelected = file;
      document.getElementById('uploadFileName').textContent = file.name;
      document.getElementById('uploadSuccess').classList.add('show');
      document.getElementById('btn-step2').disabled = false;
    }
  });

  // Lookup de matr√≠cula
  let matriculaTimer = null;
  function onMatriculaInput() {
    clearError('matricula');
    vendedorValido = false;
    document.getElementById('vendedorPreview').classList.remove('show');
    clearTimeout(matriculaTimer);
    const mat = document.getElementById('matricula').value.trim();
    if (mat.length >= 5) {
      matriculaTimer = setTimeout(() => buscarVendedor(mat), 400);
    }
  }

  const BACKEND_URL = 'https://cotas-097p.onrender.com';

  async function buscarVendedor(mat) {
    const backendUrl = BACKEND_URL;
    try {
      const res = await fetch(`${backendUrl}/vendedor/${mat}`);
      if (!res.ok) throw new Error('n√£o encontrado');
      const data = await res.json();
      document.getElementById('preview-nome').textContent = data.nome_curto + ' (' + data.nome + ')';
      document.getElementById("preview-pdv").textContent  = data.pdv;
      document.getElementById("preview-frete").textContent = data.frete ? "R$ " + data.frete : "‚Äî";
      document.getElementById('vendedorPreview').classList.add('show');
      vendedorValido = true;
    } catch {
      document.getElementById('matricula').classList.add('error');
      document.getElementById('err-matricula').classList.add('show');
      document.getElementById('err-matricula').textContent = 'Matr√≠cula n√£o encontrada';
      vendedorValido = false;
    }
  }

  function clearError(id) {
    document.getElementById(`err-${id}`).classList.remove('show');
    document.getElementById(id).classList.remove('error');
  }

  function parseQuick(raw) {
    const get = (label) => {
      const m = raw.match(new RegExp('^' + label + ':\\s*\\n([^\\n]+)', 'im'));
      return m ? m[1].trim() : '';
    };
    return { Nome: get('Nome'), CPF: get('CPF'), Modelo: get('Modelo') };
  }

  function buildSummary() {
    const raw = document.getElementById('clientData').value;
    const f = parseQuick(raw);
    document.getElementById('summary-nome').textContent   = f.Nome   || '‚Äî';
    document.getElementById('summary-cpf').textContent    = f.CPF    || '‚Äî';
    document.getElementById('summary-modelo').textContent = f.Modelo || '‚Äî';
    document.getElementById('summary-pdf').textContent    = pdfFileSelected ? pdfFileSelected.name : '‚Äî';
  }

  function validateManuais() {
    const mat      = document.getElementById('matricula').value.trim();
    const nproposta = document.getElementById('nproposta').value.trim();
    const nrecibo   = document.getElementById('nrecibo').value.trim();
    let ok = true;

    if (!mat || !vendedorValido) {
      document.getElementById('matricula').classList.add('error');
      document.getElementById('err-matricula').classList.add('show');
      document.getElementById('err-matricula').textContent = !mat ? 'Campo obrigat√≥rio' : 'Matr√≠cula n√£o encontrada';
      ok = false;
    }
    if (!nproposta) {
      document.getElementById('nproposta').classList.add('error');
      document.getElementById('err-nproposta').classList.add('show');
      ok = false;
    }
    if (!nrecibo) {
      document.getElementById('nrecibo').classList.add('error');
      document.getElementById('err-nrecibo').classList.add('show');
      ok = false;
    }
    return ok;
  }

  async function gerarPDF() {
    if (!validateManuais()) {
      showStatus('error', '‚ö† Preencha todos os campos obrigat√≥rios antes de gerar.');
      return;
    }
    const backendUrl = BACKEND_URL;
    const dados = document.getElementById('clientData').value.trim();
    if (!dados || !pdfFileSelected) { showStatus('error', '‚ö† Dados ou PDF ausentes.'); return; }

    showStatus('loading', 'Processando o documento...');
    document.getElementById('btn-gerar').disabled = true;

    try {
      const formData = new FormData();
      formData.append('pdf',       pdfFileSelected);
      formData.append('dados',     dados);
      formData.append('nproposta', document.getElementById('nproposta').value.trim());
      formData.append('nrecibo',   document.getElementById('nrecibo').value.trim());
      formData.append('matricula', document.getElementById('matricula').value.trim());

      const res = await fetch(`${backendUrl}/preencher`, { method: 'POST', body: formData });
      if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.erro || `Erro ${res.status}`); }

      const blob = await res.blob();
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url;
      const f = parseQuick(document.getElementById('clientData').value);
      a.download = `REVEMAR_${(f.Nome || 'cliente').replace(/\s+/g,'_')}.pdf`;
      a.click();
      URL.revokeObjectURL(url);

      showStatus('success', '‚úì PDF gerado e baixado com sucesso!');
      markDone(3);
    } catch (err) {
      showStatus('error', `‚ö† ${err.message}`);
    } finally {
      document.getElementById('btn-gerar').disabled = false;
    }
  }

  function showStatus(type, msg) {
    const bar = document.getElementById('statusBar');
    bar.className = `status-bar show ${type}`;
    document.getElementById('spinner').style.display = type === 'loading' ? 'block' : 'none';
    document.getElementById('statusMsg').textContent = msg;
  }

  </script>
</body>
</html>
